# Trailclass 试听课报告系统 - 后端需求规格说明书 (v1.0)

## 1. 项目概述

本项目旨在为 Trailclass 提供一套完整的试听课反馈闭环系统。管理员通过后台导入排课数据，老师通过前端进行评价，生成学生报告，管理员最后导出包含实际教学情况的数据报表。

---

## 2. 核心角色与权限

| 角色            | 权限描述                                                                                                                                            |
| --------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- |
| **管理员 (Admin)**   | 1. 导入/更新课程排期 (Excel)<br>2. 管理教材库 (增删改查)<br>3. 导出全量数据报表 (含报告链接与实际教材)                                              |
| **老师 (Teacher)**   | 1. 查看属于自己的待评价课程列表<br>2. 填写评价 (支持修改学生名、选择实际教材)<br>3. 查看已提交的报告                                                  |
| **学生/家长**         | 1. 查看/下载 H5 报告页面 (只读)                                                                             |

---

## 3. 数据库设计 (Prisma Schema)

这是系统的核心数据结构，所有的业务逻辑都基于此。

```prisma
// 1. 教材库 (Material Library)
model Material {
id String @id @default(cuid())
name String @unique // 教材名称 (如 "Football Mania")
description String? // 备注
reports Report[] // 关联：被哪些报告使用了
createdAt DateTime @default(now())
}

// 2. 课程排期表 (Class Session)
model ClassSession {
id String @id @map("_id") // 对应 Excel: 主键ID (作为唯一标识)
// --- 计划信息 (Excel 原始数据) ---
courseName String // 对应: 课程名称 (计划教材)
bookingType String? // 对应: 预约类型
excelStatus String? // 对应: 课程状态 (仅做展示，不控制逻辑)
// --- 时间信息 ---
classTimeBJ String? // 对应: 上课时间（北京）- 存字符串或Date均可
classTimeSaudi DateTime // 对应: 上课时间（沙特）- 排序依据
// --- 老师信息 ---
teacherId String // 对应: 老师ID (查询索引)
teacherName String // 对应: 老师
// --- 学生信息 ---
originalStudentName String // 对应: 学生 (原始名字)
studentId String // 对应: 学生ID
// --- 外部ID (备用) ---
talk51Id String? // 对应: 51talk预约ID
merithubId String? // 对应: MerithubID
// --- 关联 ---
report Report? // 关系: 一节课对应一份报告
createdAt DateTime @default(now())
updatedAt DateTime @updatedAt
}

// 3. 评价报告表 (Report)
model Report {
id String @id @default(cuid())
// 关联课程排期
classSession ClassSession @relation(fields: [sessionId], references: [id])
sessionId String @unique // 确保不重复评价
// --- 实际发生的数据 (用于对比) ---
actualStudentName String // 老师修改后的学生名字
// 实际使用的教材
material Material? @relation(fields: [materialId], references: [id])
materialId String?
fallbackMaterialName String? // 备用：如果老师没选库里的，存手动输入的
// --- 评价内容 ---
scores Json // 分数 { Vocabulary: 5, Grammar: 4... }
feedback String // 老师评语
createdAt DateTime @default(now())
}
```

---

## 4. 功能模块详述

### 模块一：管理员 - 课程导入 (Import)

**目标**：将排课平台的 Excel 数据同步到系统。

- **输入**：Excel 文件 (`.xlsx`)
- **触发机制**：管理员手动上传
- **处理逻辑 (Upsert)**：
    - 系统读取 Excel 中的 **“主键ID”** 列
    - **如果 ID 已存在**：更新该条记录的所有字段（应对排课变更，如时间调整、换老师）
    - **如果 ID 不存在**：创建一条新的 `ClassSession` 记录
- **字段映射表**：

    | Excel字段       | Schema字段                 |
    | --------------- | ------------------------- |
    | 课程名称        | `courseName`              |
    | 上课时间（北京）| `classTimeBJ`             |
    | 上课时间（沙特）| `classTimeSaudi` (需解析为标准 ISO 时间格式) |
    | 预约类型        | `bookingType`             |
    | 老师            | `teacherName`             |
    | 老师ID          | `teacherId`               |
    | 学生            | `originalStudentName`     |
    | 学生ID          | `studentId`               |
    | 51talk预约ID    | `talk51Id`                |
    | MerithubID      | `merithubId`              |
    | 主键ID          | `id` (Primary Key)        |
    | 课程状态        | `excelStatus`             |

---

### 模块二：管理员 - 教材管理 (Material Mgmt)

**目标**：维护标准的教材列表，供老师评价时选择。

- **功能**：
    - **列表展示**：显示所有可用教材名称
    - **添加教材**：输入名称（必填）和描述（选填）
    - **删除教材**：软删除或硬删除（视需求）
- **数据流向**：此数据将流向老师评价页的“教材选择下拉框”。

---

### 模块三：老师 - 评价流程 (Teacher Evaluate)

**目标**：老师完成对学生的评估，并修正实际上课信息。

#### 1. 课程列表页

- **筛选逻辑**：
  ```sql
  SELECT * FROM ClassSession WHERE teacherId = [当前登录ID] ORDER BY classTimeSaudi DESC
  ```
- **状态判断逻辑**：
    - 系统检查该 `ClassSession` 是否关联了 `Report`
    - **无 Report** -> 状态为 **“待评价”** (按钮：Start Evaluation)
    - **有 Report** -> 状态为 **“已完成”** (按钮：View Report)
    - *注：完全忽略 Excel 中的“课程状态”字段进行逻辑判断，只做展示*

#### 2. 评价填写页

- **数据预填充**：
    - **学生姓名**：Input 框，默认值 = `originalStudentName`，*允许老师修改*
    - **教材选择**：Select 下拉框，默认选中与 `courseName` 匹配的选项，*允许老师切换*
- **提交处理**：
    - 保存 5 维分数、评语
    - 保存 `actualStudentName` (最终框内的名字)
    - 保存 `materialId` (最终选中的教材)

---

### 模块四：管理员 - 导出与监控 (Export)

**目标**：导出全量数据，用于结算和质量监控。

- **输入**：选择时间范围（可选）
- **输出**：Excel 文件
- **导出字段定义 (包含数据对比与链接)**：

| 序号 | Excel 列名         | 数据来源                             | 说明                   |
| ---- | ------------------ | ------------------------------------ | ---------------------- |
| 1    | 主键ID             | `ClassSession.id`                    |                        |
| 2    | 课程名称 (计划)     | `ClassSession.courseName`            | 排课时的教材           |
| 3    | **实际教材名**      | `Report.Material.name`               | **重点对比字段**。若未评价为空 |
| 4    | 上课时间 (沙特)     | `ClassSession.classTimeSaudi`        |                        |
| 5    | 上课时间 (北京)     | `ClassSession.classTimeBJ`           |                        |
| 6    | 预约类型           | `ClassSession.bookingType`           |                        |
| 7    | 老师               | `ClassSession.teacherName`           |                        |
| 8    | 老师ID             | `ClassSession.teacherId`             |                        |
| 9    | 学生 (原始)        | `ClassSession.originalStudentName`   |                        |
| 10   | **学生 (实际)**     | `Report.actualStudentName`           | **老师修改后的名字**    |
| 11   | 学生ID             | `ClassSession.studentId`             |                        |
| 12   | 51talk预约ID       | `ClassSession.talk51Id`              |                        |
| 13   | MerithubID         | `ClassSession.merithubId`            |                        |
| 14   | 课程状态 (原始)     | `ClassSession.excelStatus`           | Excel 里的状态         |
| 15   | **评价状态**        | (计算字段)                           | 有 Report 则"已评价"，否则"未评价" |
| 16   | **体验课报告链接**   | (拼接字段)                           | `https://[domain]/report/[Report.id]` |

---

## 5. 开发路线图 (Next Steps)

基于此文档，我们将严格按照以下顺序进行开发：

1. **Phase 1: 基础设施 (后端)**
    - 初始化 Prisma，创建上述 3 张表
    - 配置数据库连接
2. **Phase 2: 管理员导入功能**
    - 开发教材库管理 API
    - 开发 Excel 解析与 Upsert 逻辑
    - *(完成此步后，数据库里有真实排课数据)*
3. **Phase 3: 老师端逻辑接入**
    - 开发“我的课程列表”接口
    - 改造评价提交接口（对接真实数据库）
4. **Phase 4: 管理员导出功能**
    - 编写联表查询逻辑 (Join Session + Report + Material)
    - 生成包含“报告链接”的 Excel
```
